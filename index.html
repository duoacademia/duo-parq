<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PAR-Q — DUO Academia</title>
  <meta name="description" content="Questionário PAR-Q com validação, termo de concordância (rubrica desenhada), geração de PDF e envio por WhatsApp." />
  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <!-- jsPDF AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e5e7eb;
      --line:#1f2937; --brand:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--fg)}
    .container{max-width:960px;margin:0 auto;padding:24px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:20px}
    h1{margin:0 0 12px;font-size:22px}
    .muted{color:var(--muted);font-size:14px;margin-bottom:18px}
    fieldset{border:1px solid var(--line);border-radius:10px;padding:14px 16px;margin:14px 0}
    legend{padding:0 6px;color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row label{display:flex;gap:8px;align-items:center;cursor:pointer}
    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    button{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
    button.secondary{background:#334155}
    button.ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
    button:disabled{opacity:.6;cursor:not-allowed}
    input[type="text"]{width:100%;background:#0b1324;border:1px solid var(--line);border-radius:8px;color:var(--fg);padding:10px}
    label.small{font-size:13px;color:var(--muted)}
    .error-box{
      display:none;background:#1e293b;border:1px solid var(--danger);
      color:#fecaca;border-left:6px solid var(--danger);border-radius:10px;padding:12px 14px;margin:12px 0
    }
    /* Termo */
    .termo{
      display:none;border:1px dashed var(--warn);border-radius:10px;padding:12px 14px;background:#0b1324;margin-top:12px
    }
    .termo h3{margin:0 0 6px;font-size:16px;color:#fde68a}
    .termo p{margin:6px 0 12px;color:#eab308}
    .sig-wrap{max-width:420px}
    .sig-canvas{
      width:100%;height:160px;background:#fff;border:1px solid #cbd5e1;border-radius:10px;touch-action:none
    }
    .sig-actions{display:flex;gap:10px;margin-top:8px}
    /* Modal ENVIAR PARA */
    .send-modal{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
      align-items:center;justify-content:center;padding:18px;z-index:50
    }
    .send-card{
      width:100%;max-width:460px;background:var(--panel);border:1px solid var(--line);
      border-radius:14px;padding:18px
    }
    .send-card h3{margin:0 0 8px}
    .send-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .send-option{width:100%;text-align:center;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1324}
    .close-x{float:right;background:transparent;border:0;color:var(--muted);font-size:18px;cursor:pointer}
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>PAR-Q — DUO Academia</h1>
      <p class="muted">Responda às 7 perguntas obrigatórias. Se marcar “Sim” em qualquer uma, leia e aceite o termo e desenhe sua rubrica. Depois, gere o PDF e escolha a unidade para envio.</p>

      <!-- Identificação -->
      <div class="row" style="gap:10px;margin-bottom:8px">
        <div style="flex:1 1 220px">
          <label class="small">Nome completo</label>
          <input type="text" id="nome" placeholder="Seu nome" />
        </div>
        <div style="flex:1 1 160px">
          <label class="small">CPF</label>
          <input type="text" id="cpf" placeholder="000.000.000-00" />
        </div>
      </div>

      <!-- Erros -->
      <div id="errorBox" class="error-box"></div>

      <form id="parqForm">
        <fieldset data-required>
          <legend>1) Alguma vez um médico já lhe disse que você possui um problema no coração?</legend>
          <div class="row">
            <label><input type="radio" name="q1" value="Sim" />Sim</label>
            <label><input type="radio" name="q1" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>2) Você sente dor no peito quando pratica atividade física?</legend>
          <div class="row">
            <label><input type="radio" name="q2" value="Sim" />Sim</label>
            <label><input type="radio" name="q2" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>3) No último mês, você sentiu dor no peito quando não estava praticando atividade física?</legend>
          <div class="row">
            <label><input type="radio" name="q3" value="Sim" />Sim</label>
            <label><input type="radio" name="q3" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>4) Você perde o equilíbrio por causa de tontura ou já perdeu a consciência?</legend>
          <div class="row">
            <label><input type="radio" name="q4" value="Sim" />Sim</label>
            <label><input type="radio" name="q4" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>5) Você possui algum problema ósseo ou articular que poderia piorar com a atividade física?</legend>
          <div class="row">
            <label><input type="radio" name="q5" value="Sim" />Sim</label>
            <label><input type="radio" name="q5" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>6) Seu médico está prescrevendo atualmente medicamentos para pressão arterial ou coração?</legend>
          <div class="row">
            <label><input type="radio" name="q6" value="Sim" />Sim</label>
            <label><input type="radio" name="q6" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>7) Você sabe de alguma outra razão pela qual não deve praticar atividade física?</legend>
          <div class="row">
            <label><input type="radio" name="q7" value="Sim" />Sim</label>
            <label><input type="radio" name="q7" value="Não" />Não</label>
          </div>
        </fieldset>

        <!-- TERMO + RUBRICA (Canvas) -->
        <div id="termoBox" class="termo" aria-hidden="true">
          <h3>Termo de Responsabilidade</h3>
          <p>
            Você assinalou pelo menos uma resposta “Sim”. Confirmo que estou ciente de que devo buscar avaliação médica
            antes de iniciar ou prosseguir atividades físicas. Concordo em seguir as orientações profissionais da DUO Academia.
          </p>
          <label style="display:block;margin-bottom:8px">
            <input type="checkbox" id="termo_check" /> Li e concordo com o termo acima.
          </label>
          <div class="sig-wrap">
            <label class="small">Rubrica desenhada (obrigatória quando houver "Sim")</label>
            <canvas id="canvasRubrica" class="sig-canvas"></canvas>
            <div class="sig-actions">
              <button type="button" class="ghost" id="btnLimparRubrica">Limpar rubrica</button>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="button" id="btnGerar">Gerar PDF</button>
          <button type="reset" class="secondary" id="btnReset">Limpar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal ENVIAR PARA -->
  <div id="sendModal" class="send-modal" aria-hidden="true">
    <div class="send-card">
      <button class="close-x" aria-label="Fechar" onclick="hideSendModal()">✕</button>
      <h3>ENVIAR PARA:</h3>
      <div class="send-grid">
        <button class="send-option" onclick="handleSend('centro')">Unidade Centro</button>
        <button class="send-option" onclick="handleSend('heliopolis')">Unidade Heliópolis</button>
      </div>
      <p class="muted" style="margin-top:10px">
        No desktop: o PDF baixa e o WhatsApp Web abre com mensagem pronta; anexe o arquivo baixado.
        Em muitos celulares, o compartilhamento envia o PDF direto.
      </p>
    </div>
  </div>

  <script>
    // Telefones
    const PHONES = { centro: "5587999341230", heliopolis: "5587996660021" };

    // ====== UI helpers ======
    const errorBox = document.getElementById('errorBox');
    function showError(msg){ errorBox.innerHTML = msg; errorBox.style.display='block'; errorBox.scrollIntoView({behavior:'smooth', block:'center'}); }
    function hideError(){ errorBox.style.display='none'; }
    function showSendModal(){ document.getElementById('sendModal').style.display='flex'; }
    function hideSendModal(){ document.getElementById('sendModal').style.display='none'; }

    // ====== Perguntas ======
    function validateRequiredQuestions() {
      const sets = Array.from(document.querySelectorAll('fieldset[data-required]'));
      const unanswered = [];
      sets.forEach((fs, idx) => {
        const name = 'q' + (idx + 1);
        const checked = fs.querySelector('input[name=\"'+name+'\"]:checked');
        if (!checked) unanswered.push(idx + 1);
      });
      return { ok: unanswered.length === 0, missing: unanswered };
    }
    function anyAnswerYes(){
      for(let i=1;i<=7;i++){
        const el = document.querySelector('input[name=\"q'+i+'\"]:checked');
        if (el && el.value === 'Sim') return true;
      }
      return false;
    }

    // ====== Termo + SignaturePad ======
    const termoBox = document.getElementById('termoBox');
    const termoCheck = document.getElementById('termo_check');
    const canvas = document.getElementById('canvasRubrica');
    let signaturePad = null;

    function resizeCanvas() {
      if (!canvas) return;
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      // guarda tamanho CSS
      const w = canvas.offsetWidth;
      const h = canvas.offsetHeight;
      canvas.width = w * ratio;
      canvas.height = h * ratio;
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
      if (signaturePad) signaturePad.clear();
    }

    function ensureSignaturePad(){
      if (!signaturePad) {
        signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,1)', penColor: 'rgb(0,0,0)' });
        document.getElementById('btnLimparRubrica').addEventListener('click', () => signaturePad.clear());
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
      }
    }

    function updateTermoVisibility(reset=false){
      if (reset){
        termoBox.style.display='none'; termoBox.setAttribute('aria-hidden','true');
        if (termoCheck) termoCheck.checked = false;
        if (signaturePad) signaturePad.clear();
        return;
      }
      const precisa = anyAnswerYes();
      if (precisa){
        termoBox.style.display='block'; termoBox.setAttribute('aria-hidden','false');
        ensureSignaturePad();
      }else{
        termoBox.style.display='none'; termoBox.setAttribute('aria-hidden','true');
        if (termoCheck) termoCheck.checked = false;
        if (signaturePad) signaturePad.clear();
      }
    }

    // ====== PDF ======
        async function generatePdfBlob() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });

      // Helpers
      const pad2 = (n)=> String(n).padStart(2,'0');
      const now = new Date();
      const dataStr = `${pad2(now.getDate())}/${pad2(now.getMonth()+1)}/${now.getFullYear()}`;
      const timeStr = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      const code = `${now.getFullYear()}${pad2(now.getMonth()+1)}${pad2(now.getDate())}${pad2(now.getHours())}${pad2(now.getMinutes())}${pad2(now.getSeconds())}`;

      const nome = (document.getElementById('nome').value || '').trim();
      const cpf  = (document.getElementById('cpf').value  || '').trim();

      const answers = [];
      for (let i=1;i<=7;i++){
        const q = document.querySelector('input[name="q'+i+'"]:checked');
        answers.push({ i, v: q ? q.value : '-' });
      }
      const precisaTermo = answers.some(a => a.v === 'Sim');
      const termoOk = precisaTermo ? !!(document.getElementById('termo_check') && document.getElementById('termo_check').checked) : true;

      // Load logo -> dataURL
      async function loadImageDataURL(url) {
        const res = await fetch(url, {mode:'cors'});
        const blob = await res.blob();
        return await new Promise((resolve)=>{
          const reader = new FileReader();
          reader.onload = ()=> resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      }
      let logoData = null;
      try {
        logoData = await loadImageDataURL('https://i.ibb.co/fVtJWfV3/logoduo.png');
      } catch(e) { console.warn('Falha ao carregar logo', e); }

      // --- Header ---
      const left = 14, right = 196; // A4 width 210mm, margins 14mm
      let y = 12;

      if (logoData){
        doc.addImage(logoData, 'PNG', left, y, 20, 20);
      }
      doc.setFontSize(10);
      doc.setTextColor(0,0,0);
      doc.text('DUO ACADEMIA', left+24, y+4);
      doc.setFontSize(8);
      doc.setTextColor(80);
      doc.text('Av. Simão Gomes, 726 • Heliópolis • R. Dom José, 187 • Santo Antônio', left+24, y+9);
      doc.text('(87) 9.9666-0021 | (87) 9.9934-1230 • coordenacaoduoacademia@gmail.com', left+24, y+14);

      // Code + date
      doc.setFontSize(9);
      doc.setTextColor(0);
      doc.text(`Código: ${code}`, right-60, y+4);
      doc.text(`Data: ${dataStr}`, right-60, y+10);
      y += 22;

      // Title band
      doc.setDrawColor(200);
      doc.setFillColor(245);
      doc.roundedRect(left, y, right-left, 10, 1.5, 1.5, 'F');
      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.text('ANEXO I — QUESTIONÁRIO DE PRONTIDÃO PARA ATIVIDADE FÍSICA (PAR-Q)', left+2, y+6);
      y += 14;

      // Identification table
      const lawText = 'Em conformidade com a Lei n.º 15.619/2015. Caso você responda "sim" a uma ou mais perguntas, converse com seu médico antes de aumentar seu nível atual de atividade física.';

      doc.setFontSize(10);
      doc.setDrawColor(210);
      doc.setFillColor(255);
      // Name row
      doc.rect(left, y, right-left, 8);
      doc.setFont(undefined, 'bold'); doc.text('Nome completo', left+2, y+5);
      doc.setFont(undefined, 'normal'); doc.text(nome || '(não informado)', left+45, y+5);
      y += 8;
      // CPF row
      doc.rect(left, y, right-left, 8);
      doc.setFont(undefined, 'bold'); doc.text('CPF', left+2, y+5);
      doc.setFont(undefined, 'normal'); doc.text(cpf || '(não informado)', left+45, y+5);
      y += 10;

      // Law notice box
      doc.setFontSize(9);
      doc.setTextColor(60);
      const splitLaw = doc.splitTextToSize(lawText, right-left-4);
      doc.rect(left, y, right-left, 12 + (splitLaw.length>2 ? (splitLaw.length-2)*4 : 0));
      doc.text(splitLaw, left+2, y+5);
      y += 12 + (splitLaw.length>2 ? (splitLaw.length-2)*4 : 0) + 4;

      // Questions table with autoTable
      const body = answers.map(({i,v})=>{
        return [
          `${i}. ${[
            'Apresenta problema cardíaco de qualquer tipo',
            'Sente dores no peito quando pratica exercícios',
            'Sentiu dores no peito recentes durante exercício',
            'Apresenta desequilíbrio/tontura levando ao desmaio',
            'Apresenta problema osteomioarticular que pode piorar com exercício',
            'Usa remédio para pressão/coração',
            'Conhece alguma razão para não praticar exercícios'
          ][i-1]}`,
          v === 'Sim' ? 'X' : '',
          v === 'Não' ? 'X' : ''
        ];
      });

      doc.setFontSize(10);
      doc.setTextColor(0);

      // load autotable if available
      if (!doc.autoTable) {
        // fallback manual grid if autotable not loaded
        const colW = [right-left-20, 10, 10];
        // header
        doc.setFillColor(245);
        doc.rect(left, y, colW[0]+colW[1]+colW[2], 8, 'F');
        doc.text('Pergunta', left+2, y+5);
        doc.text('S', left+colW[0]+colW[1]/2+left, y+5, {align:'center'});
        doc.text('N', left+colW[0]+colW[1]+colW[2]/2+left, y+5, {align:'center'});
        y += 8;
        body.forEach(row=>{
          const h = 10;
          doc.rect(left, y, colW[0], h);
          doc.rect(left+colW[0], y, colW[1], h);
          doc.rect(left+colW[0]+colW[1], y, colW[2], h);
          const txt = doc.splitTextToSize(row[0], colW[0]-4);
          doc.text(txt, left+2, y+5);
          if (row[1]) doc.text('X', left+colW[0]+colW[1]/2, y+6, {align:'center'});
          if (row[2]) doc.text('X', left+colW[0]+colW[1]+colW[2]/2, y+6, {align:'center'});
          y += max(10, (txt.length*4)+4);
        });
      } else {
        doc.autoTable({
          startY: y,
          head: [['Pergunta', 'S', 'N']],
          body: body,
          theme: 'grid',
          styles: { fontSize: 9, cellPadding: 3, lineColor: [210,210,210], lineWidth: 0.4 },
          headStyles: { fillColor: [245,245,245], textColor: [0,0,0], fontStyle: 'bold', halign: 'center' },
          columnStyles: {
            0: { cellWidth: right-left-22, halign: 'left' },
            1: { cellWidth: 11, halign: 'center' },
            2: { cellWidth: 11, halign: 'center' }
          },
          didDrawPage: (data) => {}
        });
        y = doc.lastAutoTable.finalY + 6;
      }

      // Termo + Rubrica
      doc.setFontSize(10);
      if (precisaTermo){
        doc.setDrawColor(210);
        doc.roundedRect(left, y, right-left, 28, 1.5, 1.5);
        doc.text('Termo de Responsabilidade:', left+2, y+6);
        const termoTxt = 'Declaro que estou ciente de que devo buscar avaliação médica antes de iniciar ou prosseguir atividades físicas e que seguirei as orientações profissionais da DUO Academia.';
        doc.setFontSize(9);
        doc.setTextColor(60);
        doc.text(doc.splitTextToSize(termoTxt, right-left-4), left+2, y+11);
        doc.setTextColor(0);
        // assinatura desenhada (rubrica)
        if (signaturePad && !signaturePad.isEmpty()){
          const imgData = signaturePad.toDataURL('image/png');
          // box label
          doc.setFontSize(9);
          doc.text('Rubrica do aluno (iniciais):', left+2, y+23);
          doc.setDrawColor(200);
          doc.rect(left+45, y+15, 40, 12); // caixa
          doc.addImage(imgData, 'PNG', left+46, y+16, 38, 10);
        } else {
          doc.setFontSize(9);
          doc.text('Rubrica do aluno (iniciais): _________________________________', left+2, y+23);
        }
      }

      // output
      const filename = `PARQ_${(nome || 'aluno').replace(/\s+/g,'_')}_${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}.pdf`;
      const blob = doc.output('blob');

      const textSummary = `PAR-Q - DUO Academia\nNome: ${nome || '(não informado)'}\nCPF: ${cpf || '(não informado)'}\n\nRespostas:\n` +
        answers.map(a=>`Q${a.i}: ${a.v}`).join('\n') +
        `\n\nTermo: ${precisaTermo ? (termoOk ? 'Concordou' : 'Não concordou') : 'Não aplicável'}`;

      return { blob, filename, textSummary };
    }

      const precisaTermo = answers.some(a => a.v === 'Sim');
      const termoOk = precisaTermo ? !!(termoCheck && termoCheck.checked) : true;

      const now = new Date();
      const pad2 = (n)=> String(n).padStart(2,'0');
      const dataStr = `${pad2(now.getDate())}/${pad2(now.getMonth()+1)}/${now.getFullYear()} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;

      // Cabeçalho
      doc.setFontSize(14);
      doc.text("PAR-Q — DUO Academia", 14, 16);
      doc.setFontSize(10);
      doc.text(`Data/Hora: ${dataStr}`, 14, 24);

      // Identificação
      doc.setFontSize(11);
      doc.text(`Nome: ${nome || '(não informado)'}`, 14, 34);
      doc.text(`CPF: ${cpf || '(não informado)'}`, 14, 41);

      // Respostas
      let y = 53;
      doc.setFontSize(12);
      doc.text("Respostas:", 14, 48);
      doc.setFontSize(11);
      answers.forEach(({i,v})=>{ doc.text(`${i}) ${v}`, 14, y); y += 7; if (y>280){ doc.addPage(); y=20; } });

      // Termo
      if (y > 230) { doc.addPage(); y = 20; }
      doc.setFontSize(12);
      doc.text("Termo de Responsabilidade:", 14, y + 6);
      doc.setFontSize(10);
      const termoStatus = precisaTermo ? (termoOk ? "Concordou" : "Não concordou") : "Não aplicável (todas respostas 'Não')";
      doc.text(`Status: ${termoStatus}`, 14, y + 13);
      y += 22;

      // Rubrica desenhada
      if (precisaTermo && signaturePad && !signaturePad.isEmpty()){
        try{
          const imgData = signaturePad.toDataURL('image/png');
          const imgW = 80, imgH = 40;
          if (y + imgH + 10 > 290){ doc.addPage(); y = 20; }
          doc.setFontSize(10);
          doc.text("Rubrica desenhada:", 14, y);
          doc.addImage(imgData, 'PNG', 14, y + 4, imgW, imgH);
          y += imgH + 12;
        }catch(e){ console.warn('Falha ao inserir rubrica no PDF', e); }
      }

      const filename = `PARQ_${(nome || 'aluno').replace(/\s+/g,'_')}_${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}.pdf`;
      const blob = doc.output('blob');

      const textSummary = `PAR-Q - DUO Academia\nNome: ${nome || '(não informado)'}\nCPF: ${cpf || '(não informado)'}\n\nRespostas:\n` +
        answers.map(a=>`Q${a.i}: ${a.v}`).join('\n') +
        `\n\nTermo: ${termoStatus}${(precisaTermo && signaturePad && !signaturePad.isEmpty()) ? `\nRubrica: (imagem anexada no PDF)` : ''}`;

      return { blob, filename, textSummary };
    }

    async function shareOrDownloadThenWhatsApp(unitKey) {
      const phone = PHONES[unitKey]; if (!phone) return;
      const { blob, filename, textSummary } = await generatePdfBlob();
      const files = [new File([blob], filename, { type: 'application/pdf' })];

      if (navigator.canShare && navigator.canShare({ files })) {
        try {
          await navigator.share({ files, title: 'PAR-Q — DUO Academia', text: 'Segue meu PAR-Q em PDF.' });
          const msg = encodeURIComponent(`Enviei o meu PAR-Q em PDF.\n\n${textSummary}`);
          window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
          return;
        } catch (e) { console.warn('Share cancelado/indisponível', e); }
      }
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = filename;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
      const msg = encodeURIComponent(`Olá! Segue meu PAR-Q. Baixei o PDF e vou anexar na conversa.\n\n${textSummary}`);
      window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
    }

    async function handleSend(unitKey){ hideSendModal(); await shareOrDownloadThenWhatsApp(unitKey); }

    // ====== Eventos ======
    document.getElementById('parqForm').addEventListener('change', () => {
      updateTermoVisibility(false);
    });
    document.getElementById('btnReset').addEventListener('click', () => {
      setTimeout(()=>{ hideError(); hideSendModal(); updateTermoVisibility(true); },0);
    });

    document.getElementById('btnGerar').addEventListener('click', () => {
      hideError();
      const res = validateRequiredQuestions();
      if (!res.ok) {
        const faltam = res.missing.length;
        const lista = res.missing.map(n => `Pergunta ${n}`).join(', ');
        showError(`Você precisa responder todas as 7 perguntas obrigatórias. Faltam: <strong>${faltam}</strong> (${lista}).`);
        return;
      }
      const precisa = anyAnswerYes();
      if (precisa){
        if (!termoCheck.checked){
          showError(`Para prosseguir, marque a opção <strong>"Li e concordo com o termo"</strong>.`);
          return;
        }
        if (!signaturePad || signaturePad.isEmpty()){
          showError(`Desenhe sua <strong>rubrica</strong> no quadro branco para prosseguir.`);
          return;
        }
      }
      showSendModal();
    });

    // Estado inicial
    updateTermoVisibility(true);
  </script>
</body>
</html>
