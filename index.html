<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PAR-Q — DUO Academia</title>
  <meta name="description" content="Questionário PAR-Q com validação, geração de PDF e envio rápido por WhatsApp." />
  <!-- jsPDF para gerar PDF (CDN leve) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e5e7eb;
      --line:#1f2937; --brand:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--fg)}
    .container{max-width:960px;margin:0 auto;padding:24px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:20px}
    h1{margin:0 0 12px;font-size:22px}
    .muted{color:var(--muted);font-size:14px;margin-bottom:18px}
    fieldset{border:1px solid var(--line);border-radius:10px;padding:14px 16px;margin:14px 0}
    legend{padding:0 6px;color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row label{display:flex;gap:8px;align-items:center;cursor:pointer}
    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    button{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
    button.secondary{background:#334155}
    button:disabled{opacity:.6;cursor:not-allowed}
    .error-box{
      display:none;background:#1e293b;border:1px solid var(--danger);
      color:#fecaca;border-left:6px solid var(--danger);border-radius:10px;padding:12px 14px;margin:12px 0
    }
    .success{color:var(--ok);font-weight:600}
    /* Mini-modal de envio */
    .send-modal{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
      align-items:center;justify-content:center;padding:18px;z-index:50
    }
    .send-card{
      width:100%;max-width:460px;background:var(--panel);border:1px solid var(--line);
      border-radius:14px;padding:18px
    }
    .send-card h3{margin:0 0 8px}
    .send-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .send-option{width:100%;text-align:center;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1324}
    .close-x{float:right;background:transparent;border:0;color:var(--muted);font-size:18px;cursor:pointer}
    input[type="text"]{width:100%;background:#0b1324;border:1px solid var(--line);border-radius:8px;color:var(--fg);padding:10px}
    label.small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>PAR-Q — DUO Academia</h1>
      <p class="muted">Responda às 7 perguntas obrigatórias. Ao final, gere o PDF e escolha para qual unidade enviar.</p>

      <!-- Identificação básica para o PDF -->
      <div class="row" style="gap:10px;margin-bottom:8px">
        <div style="flex:1 1 220px">
          <label class="small">Nome completo</label>
          <input type="text" id="nome" placeholder="Seu nome" />
        </div>
        <div style="flex:1 1 160px">
          <label class="small">CPF</label>
          <input type="text" id="cpf" placeholder="000.000.000-00" />
        </div>
      </div>

      <!-- Caixa de erro -->
      <div id="errorBox" class="error-box"></div>

      <!-- PERGUNTAS (7 obrigatórias) -->
      <form id="parqForm">
        <!-- Exemplo de pergunta: use name únicos q1..q7 (radio) -->
        <fieldset data-required>
          <legend>1) Alguma vez um médico já lhe disse que você possui um problema no coração?</legend>
          <div class="row">
            <label><input type="radio" name="q1" value="Sim" />Sim</label>
            <label><input type="radio" name="q1" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>2) Você sente dor no peito quando pratica atividade física?</legend>
          <div class="row">
            <label><input type="radio" name="q2" value="Sim" />Sim</label>
            <label><input type="radio" name="q2" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>3) No último mês, você sentiu dor no peito quando não estava praticando atividade física?</legend>
          <div class="row">
            <label><input type="radio" name="q3" value="Sim" />Sim</label>
            <label><input type="radio" name="q3" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>4) Você perde o equilíbrio por causa de tontura ou já perdeu a consciência?</legend>
          <div class="row">
            <label><input type="radio" name="q4" value="Sim" />Sim</label>
            <label><input type="radio" name="q4" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>5) Você possui algum problema ósseo ou articular que poderia piorar com a atividade física?</legend>
          <div class="row">
            <label><input type="radio" name="q5" value="Sim" />Sim</label>
            <label><input type="radio" name="q5" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>6) Seu médico está prescrevendo atualmente medicamentos para pressão arterial ou coração?</legend>
          <div class="row">
            <label><input type="radio" name="q6" value="Sim" />Sim</label>
            <label><input type="radio" name="q6" value="Não" />Não</label>
          </div>
        </fieldset>
        <fieldset data-required>
          <legend>7) Você sabe de alguma outra razão pela qual não deve praticar atividade física?</legend>
          <div class="row">
            <label><input type="radio" name="q7" value="Sim" />Sim</label>
            <label><input type="radio" name="q7" value="Não" />Não</label>
          </div>
        </fieldset>

        <div class="actions">
          <button type="button" id="btnGerar">Gerar PDF</button>
          <button type="reset" class="secondary">Limpar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal ENVIAR PARA -->
  <div id="sendModal" class="send-modal" aria-hidden="true">
    <div class="send-card">
      <button class="close-x" aria-label="Fechar" onclick="hideSendModal()">✕</button>
      <h3>ENVIAR PARA:</h3>
      <div class="send-grid">
        <button class="send-option" onclick="handleSend('centro')">Unidade Centro</button>
        <button class="send-option" onclick="handleSend('heliopolis')">Unidade Heliópolis</button>
      </div>
      <p class="muted" style="margin-top:10px">
        Dica: no desktop, o arquivo é baixado e o WhatsApp Web abre com a mensagem pronta;
        basta anexar o PDF baixado. Em muitos celulares, o compartilhamento envia o PDF direto.
      </p>
    </div>
  </div>

  <script>
    // Telefones das unidades (formato internacional sem +)
    const PHONES = {
      centro: "5587999341230",
      heliopolis: "5587996660021"
    };

    // Utilitário: valida se as 7 perguntas com data-required foram respondidas
    function validateRequiredQuestions() {
      const sets = Array.from(document.querySelectorAll('fieldset[data-required]'));
      const unanswered = [];
      sets.forEach((fs, idx) => {
        const name = 'q' + (idx + 1);
        const checked = fs.querySelector(`input[name="${name}"]:checked`);
        if (!checked) unanswered.push(idx + 1);
      });
      return { ok: unanswered.length === 0, missing: unanswered };
    }

    // Mostra / esconde a caixa de erro
    function showError(msg) {
      const box = document.getElementById('errorBox');
      box.innerHTML = msg;
      box.style.display = 'block';
      box.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    function hideError(){ const box = document.getElementById('errorBox'); box.style.display='none'; }

    // Modal ENVIAR PARA
    function showSendModal(){ document.getElementById('sendModal').style.display='flex'; }
    function hideSendModal(){ document.getElementById('sendModal').style.display='none'; }

    // Gera o PDF (retorna { blob, filename, textSummary })
    async function generatePdfBlob() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const nome = (document.getElementById('nome').value || '').trim();
      const cpf  = (document.getElementById('cpf').value  || '').trim();

      const answers = [];
      for (let i=1;i<=7;i++){
        const checked = document.querySelector(`input[name="q${i}"]:checked`);
        answers.push({ i, v: checked ? checked.value : '-' });
      }

      const today = new Date();
      const pad2 = (n)=> String(n).padStart(2,'0');
      const dataStr = `${pad2(today.getDate())}/${pad2(today.getMonth()+1)}/${today.getFullYear()} ${pad2(today.getHours())}:${pad2(today.getMinutes())}`;

      // Cabeçalho
      doc.setFontSize(14);
      doc.text("PAR-Q — DUO Academia", 14, 16);
      doc.setFontSize(10);
      doc.text(`Data/Hora: ${dataStr}`, 14, 24);

      // Identificação
      doc.setFontSize(11);
      doc.text(`Nome: ${nome || '(não informado)'}`, 14, 34);
      doc.text(`CPF: ${cpf || '(não informado)'}`, 14, 41);

      // Respostas
      let y = 53;
      doc.setFontSize(12);
      doc.text("Respostas:", 14, 48);
      doc.setFontSize(11);
      answers.forEach(({i,v})=>{
        doc.text(`${i}) ${v}`, 14, y);
        y += 7;
        if (y > 280) { doc.addPage(); y = 20; }
      });

      // Rodapé simples
      if (y > 260) { doc.addPage(); y = 20; }
      doc.setFontSize(9);
      doc.text("Declaro que as informações acima são verdadeiras.", 14, y + 10);

      const filename = `PARQ_${(nome || 'aluno').replace(/\s+/g,'_')}_${today.getFullYear()}-${pad2(today.getMonth()+1)}-${pad2(today.getDate())}.pdf`;
      const blob = doc.output('blob');

      // Pequeno resumo em texto para colar na mensagem do WhatsApp
      const textSummary = `PAR-Q - DUO Academia\nNome: ${nome || '(não informado)'}\nCPF: ${cpf || '(não informado)'}\n\nRespostas:\n` +
        answers.map(a=>`Q${a.i}: ${a.v}`).join('\n');

      return { blob, filename, textSummary };
    }

    // Tenta compartilhar o PDF via Web Share (mobile), senão baixa e abre WhatsApp com texto
    async function shareOrDownloadThenWhatsApp(unitKey) {
      const phone = PHONES[unitKey];
      if (!phone) return;

      const { blob, filename, textSummary } = await generatePdfBlob();

      const files = [new File([blob], filename, { type: 'application/pdf' })];

      // Se o navegador suportar compartilhamento de arquivos (mobile)
      if (navigator.canShare && navigator.canShare({ files })) {
        try {
          await navigator.share({
            files,
            title: 'PAR-Q — DUO Academia',
            text: `Segue meu PAR-Q em PDF.`
          });
          // Depois de compartilhar, também abre WhatsApp com a mensagem pronta (sem anexo automático)
          const msg = encodeURIComponent(`Enviei o meu PAR-Q em PDF.\n\n${textSummary}`);
          window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
          return;
        } catch (e) {
          // se o usuário cancelar o share, continua para download + wa.me
          console.warn('Compartilhamento cancelado/indisponível, seguindo com download + WhatsApp.', e);
        }
      }

      // Fallback (desktop ou sem suporte ao share): baixa o PDF e abre WhatsApp com texto
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();

      const msg = encodeURIComponent(
        `Olá! Segue meu PAR-Q. Baixei o PDF e vou anexar na conversa.\n\n${textSummary}`
      );
      window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
    }

    // Clique nas opções do modal
    async function handleSend(unitKey){
      hideSendModal();
      await shareOrDownloadThenWhatsApp(unitKey);
    }

    // Clique no botão "Gerar PDF"
    document.getElementById('btnGerar').addEventListener('click', async () => {
      hideError();

      // Validação obrigatória (7 perguntas)
      const res = validateRequiredQuestions();
      if (!res.ok) {
        const faltam = res.missing.length;
        const lista = res.missing.map(n => `Pergunta ${n}`).join(', ');
        showError(`Você precisa responder todas as 7 perguntas obrigatórias. Faltam: <strong>${faltam}</strong> (${lista}).`);
        return;
      }

      // Se passou na validação, abre o modal de envio
      showSendModal();
    });
  </script>
</body>
</html>
